<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Example</title>
</head>
<body>
<script>
function websocketUrl() {
  var l = window.location;
  return ((l.protocol === 'https:') ? 'wss://' : 'ws://') + l.host + '/ws/raids';
}

(function() {
  var d = document;
  var bossesDiv = d.createElement('div');
  d.body.appendChild(bossesDiv);

  var raidsDiv = d.createElement('div');
  d.body.appendChild(raidsDiv);

  var ws = new WebSocket(websocketUrl(), ['json']);
  ws.onopen = function(event) {
    ws.send(JSON.stringify({'raidBossesMessage': {}}));
  };

  ws.onclose = function(event) {
    console.log("WebSocket closed: " + event.reason + "(" + event.code + ")")
  };

  ws.onmessage = function(event) {
    var envelope = JSON.parse(event.data);
    if (envelope.raidBossesMessage) {
      envelope.raidBossesMessage.raidBosses.forEach(function(raidBoss) {
        raidBoss.followed = false; // This is so hacky

        var img = d.createElement('img');
        img.src = raidBoss.image.value + ':thumb';
        img.style.opacity = '0.5';
        img.addEventListener('click', function() {
          raidBoss.followed = !raidBoss.subscribed;
          var action = raidBoss.susbcribed ? 'UNSUBSCRIBE' : 'SUBSCRIBE';
          img.style.opacity = raidBoss.subscribed ? '1.0' : '0.5';
          ws.send('ey');
          ws.send(JSON.stringify({
            subscriptionChangeMessage: {
              bossNames: [raidBoss.bossName],
              action: action
            }
          }));
        });
        bossesDiv.appendChild(img);
      });
    } else if (envelope.raidTweetMessage) {
      var msg = envelope.raidTweetMessage

      var userImage = d.createElement('img');
      userImage.src = msg.profileImage;

      var screenName = d.createElement('span');
      screenName.innerHTML = '@' + msg.screenName + ' ';

      var raidTweetHolder = d.createElement('div');
      raidTweetHolder.appendChild(userImage);
      raidTweetHolder.appendChild(screenName);

      raidTweetHolder.innerHTML += [msg.bossName, msg.raidId, msg.text].join(' ');
      raidsDiv.insertBefore(raidTweetHolder, raidsDiv.firstChild);
    }
  };
}());
</script>
</body>
</html>

